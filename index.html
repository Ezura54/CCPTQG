<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸´åºŠè¯å¸ˆç†è®ºè¯•é¢˜æ™ºèƒ½ç”Ÿæˆå™¨ v4.1 (ä¿®å¤ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Markdown Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f3f4f6; }

        /* Paper Style */
        .paper-container {
            background-color: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 20mm;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); color: #000;
            font-family: 'Noto Serif SC', 'SimSun', serif; line-height: 1.6;
        }

        /* Markdown Content Styling */
        .exam-content h1 { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 10px; page-break-before: always; }
        .exam-content h1:first-child { page-break-before: auto; }
        .exam-content .exam-header-info { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 30px; font-family: sans-serif; font-size: 14px; }
        .exam-content h2 { font-size: 18px; font-weight: 700; margin-top: 25px; background-color: #f0f0f0; border-left: 5px solid #4b5563; padding: 5px 10px; }
        .exam-content p { margin-bottom: 10px; text-align: justify; }
        
        /* Table Support */
        .exam-content table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9em; page-break-inside: avoid; }
        .exam-content th, .exam-content td { border: 1px solid #333; padding: 6px; }
        .exam-content th { background-color: #e5e7eb; font-weight: bold; }
        
        .knowledge-point { font-size: 0.9em; color: #666; font-family: sans-serif; float: right; font-style: italic; }
        
        /* Utility */
        .kp-checkbox:checked + div { background-color: #eff6ff; border-color: #3b82f6; color: #1e40af; }

        @media print {
            body * { visibility: hidden; }
            #previewContainer, #previewContainer * { visibility: visible; }
            #previewContainer { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
            aside, header { display: none; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-white shadow-sm z-20 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><i class="fa-solid fa-bolt"></i></div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 leading-tight">ä¸´åºŠè¯å¸ˆè¯•é¢˜ç”Ÿæˆå™¨</h1>
                    <p class="text-xs text-gray-500">v4.1 ä¿®å¤ç‰ˆ | ä¿®å¤äº†å˜é‡å¼•ç”¨é”™è¯¯</p>
                </div>
            </div>
            <div class="flex space-x-3">
                <button onclick="printExam()" class="px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm flex items-center gap-2"><i class="fa-solid fa-print"></i> æ‰“å°</button>
                <button onclick="exportToWord()" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm flex items-center gap-2"><i class="fa-solid fa-file-word"></i> å¯¼å‡º</button>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-1/3 bg-white border-r border-gray-200 flex flex-col overflow-y-auto shadow-inner z-10">
            <div class="p-6 space-y-6">
                
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <label class="block text-sm font-bold text-indigo-900 mb-2"><i class="fa-solid fa-brain mr-1"></i> æ¨¡å‹è®¾ç½®</label>
                    <select id="apiProvider" onchange="toggleModelSelect()" class="w-full mb-2 text-sm border-gray-300 rounded-md p-2 border">
                        <option value="gemini">Google Gemini (é•¿æ–‡æœ¬æ¨è)</option>
                        <option value="custom">SiliconFlow/DeepSeek (OpenAIå…¼å®¹)</option>
                        <option value="openai">OpenAI (å®˜æ–¹)</option>
                    </select>
                    <div id="geminiModelSelect" class="mb-2">
                        <select id="geminiModelId" class="w-full text-sm border-gray-300 rounded-md p-2 border">
                            <option value="gemini-2.5-flash-preview-09-2025">gemini-2.5-flash (è¶…é•¿çª—)</option>
                            <option value="gemini-1.5-pro">gemini-1.5-pro (å¼ºæ¨ç†)</option>
                        </select>
                    </div>
                    <div id="customConfig" class="mb-2 hidden space-y-2 border-l-2 border-indigo-300 pl-2">
                        <input type="text" id="customBaseUrl" value="https://api.siliconflow.cn/v1" placeholder="Base URL" class="w-full text-xs border-gray-300 rounded p-1 border">
                        <input type="text" id="customModelId" value="deepseek-ai/DeepSeek-V3" placeholder="Model ID" class="w-full text-xs border-gray-300 rounded p-1 border">
                    </div>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ API Key" class="w-full text-sm border-gray-300 rounded-md p-2 border">
                </div>

                <div>
                    <h2 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                        <span class="bg-gray-200 text-gray-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">1</span>
                        å¯¼å…¥çŸ¥è¯†åº“
                    </h2>
                    
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer relative group">
                        <input type="file" id="fileInput" multiple accept=".pdf, .md, .json, .txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="space-y-1">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 group-hover:text-indigo-500 transition"></i>
                            <p class="text-sm font-medium text-gray-700">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶</p>
                            <p class="text-xs text-gray-500">PDF(æé€Ÿè§£æ), MD, JSON</p>
                        </div>
                    </div>

                    <div id="pdfSettings" class="hidden mt-2 bg-gray-50 p-2 rounded border border-gray-200">
                        <label class="block text-xs font-semibold text-gray-500 mb-1">PDF è§£ææ–¹å¼</label>
                        <select id="parsingEngine" onchange="toggleParserConfig()" class="w-full text-xs border-gray-300 rounded p-1 border">
                            <option value="pdfjs">âš¡ æœ¬åœ°æé€Ÿ (PDF.js å¤šçº¿ç¨‹)</option>
                            <option value="mineru_api">ğŸ§  Mineru API (ä¿ç•™è¡¨æ ¼ç»“æ„)</option>
                        </select>
                        <div id="mineruConfig" class="hidden mt-2 pt-2 border-t border-gray-200 space-y-1">
                            <input type="text" id="mineruUrl" placeholder="API URL" class="w-full text-xs border-gray-300 rounded p-1 border">
                        </div>
                    </div>

                    <div id="fileList" class="mt-3 space-y-2 text-sm"></div>
                    
                    <!-- Stats Display (New) -->
                    <div class="flex justify-between items-center mt-2 px-1">
                        <span class="text-xs text-gray-500" id="fileCountDisplay">æœªé€‰æ‹©æ–‡ä»¶</span>
                        <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded" id="charCountDisplay">0 å­—ç¬¦</span>
                    </div>

                    <!-- Status Bar -->
                    <div id="progressContainer" class="hidden mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mb-1">
                            <div id="progressBar" class="bg-indigo-600 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="uploadStatus" class="text-xs text-indigo-600 font-medium"></p>
                    </div>
                </div>

                <div>
                    <h2 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                        <span class="bg-gray-200 text-gray-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">2</span>
                        è¯•å·ç»“æ„
                    </h2>
                    <input type="text" id="examTitle" value="2025å¹´ä¸´åºŠè¯å¸ˆè§„èŒƒåŒ–åŸ¹è®­ä¸“ä¸šè€ƒæ ¸è¯•å·" class="w-full text-sm border-gray-300 rounded-md p-2 border mb-2">
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div><label class="text-[10px] text-gray-500">Aå‹</label><input type="number" id="countA" value="5" class="w-full text-xs p-1 border rounded text-center"></div>
                        <div><label class="text-[10px] text-gray-500">Bå‹</label><input type="number" id="countB" value="1" class="w-full text-xs p-1 border rounded text-center"></div>
                        <div><label class="text-[10px] text-gray-500">Xå‹</label><input type="number" id="countX" value="2" class="w-full text-xs p-1 border rounded text-center"></div>
                        <div><label class="text-[10px] text-gray-500">æ¡ˆä¾‹</label><input type="number" id="countCase" value="1" class="w-full text-xs p-1 border rounded text-center"></div>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden flex flex-col">
                    <h2 class="text-sm font-bold text-gray-700 mb-2 flex items-center justify-between">
                        <span class="flex items-center"><span class="bg-gray-200 text-gray-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">3</span>è€ƒç‚¹</span>
                        <button onclick="toggleAllKP()" class="text-xs text-indigo-600">å…¨é€‰</button>
                    </h2>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg flex-1 overflow-y-auto p-2 space-y-1" id="kpContainer"></div>
                </div>

                <button id="generateBtn" onclick="generateExam()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-bold shadow-md mt-4 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> å¼€å§‹ç”Ÿæˆè¯•å·
                </button>
            </div>
        </aside>

        <main class="w-2/3 bg-gray-200 p-8 overflow-y-auto flex justify-center">
            <div id="previewContainer" class="paper-container exam-content relative">
                <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-0">
                    <i class="fa-solid fa-bolt text-6xl mb-4 opacity-30"></i>
                    <p class="text-lg font-serif">è¯·å¯¼å…¥çŸ¥è¯†åº“</p>
                    <p class="text-sm opacity-60">å·²å¯ç”¨å¤šçº¿ç¨‹å¹¶è¡Œè§£æï¼Œé€Ÿåº¦æå‡æ˜æ˜¾</p>
                </div>
                <div id="markdownOutput" class="relative z-10 min-h-[500px]"></div>
            </div>
        </main>
    </main>

    <script>
        // --- Init & Data ---
        // Use an array to store text chunks instead of one giant string to reduce memory thrashing during appends
        let extractedChunks = []; 
        
        const knowledgePoints = [
            "ï¼ˆ11ï¼‰åŒ»å­¦åŸºç¡€ï¼ˆè§£å‰–ã€ç”Ÿç†ï¼‰", "ï¼ˆ12ï¼‰ä¸´åºŠæ£€éªŒæ„ä¹‰", "ï¼ˆ13ï¼‰ä¸´åºŠè¡¨ç°", "ï¼ˆ14ï¼‰ç–¾ç—…è¯Šæ–­",
            "ï¼ˆ15ï¼‰ç–¾ç—…æ²»ç–—åŸåˆ™", "ï¼ˆ16ï¼‰è¯ç‰©é€‚åº”ç—‡/ç¦å¿Œè¯", "ï¼ˆ17ï¼‰è¯ä»£/è¯æ•ˆåŠ¨åŠ›å­¦", "ï¼ˆ18ï¼‰ä¸ªä½“åŒ–ç»™è¯æ–¹æ¡ˆ",
            "ï¼ˆ19ï¼‰è¯ç‰©ä¸è‰¯ååº”(ADR)", "ï¼ˆ20ï¼‰è¯ç‰©ç›¸äº’ä½œç”¨", "ï¼ˆ21ï¼‰è¯å­¦ç›‘æŠ¤è®¡åˆ’", "ï¼ˆ22ï¼‰æ‚£è€…ç”¨è¯æ•™è‚²"
        ];

        function initKP() {
            const c = document.getElementById('kpContainer');
            c.innerHTML = knowledgePoints.map(k => `
                <label class="flex items-start cursor-pointer group">
                    <input type="checkbox" class="kp-checkbox hidden" value="${k}" checked>
                    <div class="w-full border border-gray-200 bg-white p-2 rounded text-xs text-gray-600 flex items-center hover:border-indigo-300">
                        <i class="fa-solid fa-check text-indigo-600 mr-2 opacity-0"></i><span class="flex-1">${k}</span>
                    </div>
                </label>`).join('');
        }
        initKP();
        function toggleAllKP() { document.querySelectorAll('.kp-checkbox').forEach(c => c.checked = !c.checked); }
        function toggleModelSelect() {
            const v = document.getElementById('apiProvider').value;
            document.getElementById('geminiModelSelect').classList.toggle('hidden', v !== 'gemini');
            document.getElementById('customConfig').classList.toggle('hidden', v !== 'custom');
        }
        function toggleParserConfig() {
            document.getElementById('mineruConfig').classList.toggle('hidden', document.getElementById('parsingEngine').value !== 'mineru_api');
        }

        // --- Optimized File Parsing ---
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadStatus = document.getElementById('uploadStatus');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        
        // Helper to update UI
        function setProgress(percent, msg) {
            progressContainer.classList.remove('hidden');
            progressBar.style.width = `${percent}%`;
            if(msg) uploadStatus.textContent = msg;
        }

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if(!files.length) return;
            
            extractedChunks = []; // Reset
            fileList.innerHTML = "";
            document.getElementById('fileCountDisplay').textContent = "æ­£åœ¨å¤„ç†...";
            document.getElementById('charCountDisplay').textContent = "0 å­—ç¬¦";
            document.getElementById('generateBtn').disabled = true;
            
            let hasPDF = false;
            let completed = 0;

            for(let file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                if(ext === 'pdf') hasPDF = true;

                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-100 text-xs";
                let icon = ext === 'pdf' ? "fa-file-pdf text-red-500" : (ext === 'md' ? "fa-file-code text-blue-500" : "fa-file");
                div.innerHTML = `<span class="truncate w-3/4"><i class="fa-solid ${icon} mr-2"></i>${file.name}</span><i class="fa-solid fa-spinner fa-spin text-gray-400 status-icon"></i>`;
                fileList.appendChild(div);

                // Use setTimeout to allow UI to render before heavy processing
                await new Promise(r => setTimeout(r, 10));

                try {
                    let content = "";
                    setProgress(Math.round((completed / files.length) * 100), `æ­£åœ¨è§£æ ${file.name}...`);

                    if (ext === 'pdf') {
                        const engine = document.getElementById('parsingEngine').value;
                        if(engine === 'pdfjs') content = await parsePdfLocal(file);
                        else content = await parsePdfMineruApi(file);
                    } else if (ext === 'md' || ext === 'txt') {
                        content = await parseTextFile(file);
                    } else if (ext === 'json') {
                        content = await parseMineruJson(file);
                    }

                    extractedChunks.push(`\n\n=== æ¥æº: ${file.name} (${ext}) ===\n${content}\n`);
                    div.querySelector('.status-icon').className = "fa-solid fa-check text-green-500";
                } catch(err) {
                    console.error(err);
                    div.querySelector('.status-icon').className = "fa-solid fa-exclamation-triangle text-red-500";
                    div.title = err.message;
                }
                completed++;
            }

            document.getElementById('pdfSettings').classList.toggle('hidden', !hasPDF);
            
            const totalLength = extractedChunks.reduce((acc, curr) => acc + curr.length, 0);
            
            // Update Stats UI
            document.getElementById('fileCountDisplay').textContent = `å·²åŠ è½½ ${files.length} ä¸ªæ–‡ä»¶`;
            document.getElementById('charCountDisplay').textContent = `${totalLength.toLocaleString()} å­—ç¬¦`;

            setProgress(100, `å°±ç»ª`);
            setTimeout(() => progressContainer.classList.add('hidden'), 3000);
            
            document.getElementById('generateBtn').disabled = false;
        });

        // 1. Plain Text
        function parseTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        // 2. Mineru JSON
        async function parseMineruJson(file) {
            const text = await parseTextFile(file);
            try {
                const json = JSON.parse(text);
                let result = "";
                if (json.pdf_info && (json.block_info || json.para_blocks)) {
                    const blocks = json.block_info || json.para_blocks;
                    // Optimization: Use map+join instead of +=
                    result = blocks.map(block => {
                        if (block.lines) return block.lines.map(l => l.spans?.map(s => s.content).join('')).join('\n');
                        if (block.text) return block.text + "\n";
                        return "";
                    }).join('\n');
                } else {
                    result = json.markdown || json.content || JSON.stringify(json, null, 2); 
                }
                return result || "ç©ºå†…å®¹";
            } catch (e) { return "JSON è§£æå¤±è´¥: " + e.message; }
        }

        // 3. Optimized PDF Parsing (Parallel)
        async function parsePdfLocal(file) {
            const buf = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(buf).promise;
            
            // Optimization: Fetch all pages in parallel using Promise.all
            // This is significantly faster than await-ing each page in a loop
            const pagePromises = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                pagePromises.push(
                    pdf.getPage(i).then(page => 
                        page.getTextContent().then(textContent => 
                            textContent.items.map(s => s.str).join(' ')
                        )
                    )
                );
            }
            
            const pageTexts = await Promise.all(pagePromises);
            return pageTexts.join('\n\n');
        }

        // 4. Remote PDF
        async function parsePdfMineruApi(file) {
            const url = document.getElementById('mineruUrl').value;
            if(!url) throw new Error("éœ€é…ç½® Mineru API URL");
            const fd = new FormData(); fd.append('file', file);
            const res = await fetch(url, { method:'POST', body:fd });
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            return data.markdown || data.result || JSON.stringify(data);
        }

        // --- Generator Logic (Algorithm Optimization) ---
        function optimizeContext(chunksArray, kps, max) {
            // Join first to get full text, then split by paragraphs
            // Note: In a real worker, we wouldn't join, but for simplicity we join then split efficiently
            const fullText = chunksArray.join('\n');
            if(fullText.length <= max) return fullText;

            const splitChunks = fullText.split(/\n\s*\n/);
            
            // Optimization: Create a RegExp once instead of looping string.includes()
            // Remove special regex chars from KPs first
            const cleanKPs = kps.map(k => k.replace(/^[ï¼ˆ(]\d+[ï¼‰)]/, '').trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
            const kpRegex = new RegExp(cleanKPs.join('|'), 'i'); // Case insensitive

            // Score chunks
            const scored = splitChunks.map((c, i) => {
                let s = 0;
                // Fast regex check
                if (kpRegex.test(c)) s += 10; 
                if (c.includes('|') && c.includes('---')) s += 15; // Prefer tables
                // Length penalty for tiny fragments
                if (c.length < 20) s -= 5;
                return { t: c, s: s, i: i };
            });

            // Sort by score descending
            scored.sort((a, b) => b.s - a.s);

            // Select top chunks until limit
            let resIndices = [];
            let currentLen = 0;
            
            // Always include metadata (first chunk)
            if(scored.length > 0) {
                // Find index 0
                const head = scored.find(x => x.i === 0);
                if(head) { resIndices.push(0); currentLen += head.t.length; }
            }

            for(let item of scored) {
                if(item.i === 0) continue; // Already added
                if(currentLen + item.t.length > max) break;
                resIndices.push(item.i);
                currentLen += item.t.length;
            }

            // Sort indices to maintain document flow
            resIndices.sort((a, b) => a - b);
            
            return resIndices.map(i => splitChunks[i]).join('\n\n');
        }

        async function generateExam() {
            const key = document.getElementById('apiKey').value;
            if(!key) return alert("è¯·è¾“å…¥ API Key");
            if(!extractedChunks.length) return alert("è¯·å…ˆå¯¼å…¥æ–‡ä»¶");

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨æ„å»º Prompt...`;
            
            // Allow UI to update
            await new Promise(r => setTimeout(r, 50));

            document.getElementById('placeholder').classList.add('hidden');
            const outputDiv = document.getElementById('markdownOutput');
            outputDiv.innerHTML = `<div class="p-10 text-center text-gray-500 animate-pulse">æ­£åœ¨å‘ AI å‘é€æ•°æ®...<br>è¿™å¯èƒ½éœ€è¦ 30ç§’ - 2åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚</div>`;

            // Config - FIXED VARIABLE NAME HERE
            const config = {
                A: document.getElementById('countA').value,
                B: document.getElementById('countB').value,
                X: document.getElementById('countX').value,
                Case: document.getElementById('countCase').value,
                Title: document.getElementById('examTitle').value
            };
            // KP - FIXED VARIABLE NAME HERE
            const selectedKPs = Array.from(document.querySelectorAll('.kp-checkbox:checked')).map(c=>c.value);
            
            // Limit strategy
            const provider = document.getElementById('apiProvider').value;
            const limit = provider === 'gemini' ? 2000000 : 60000; // Adjusted for safety
            
            // Run optimize logic (using selectedKPs variable)
            const context = optimizeContext(extractedChunks, selectedKPs, limit);

            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> AI æ€è€ƒä¸­...`;

 const sys = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸´åºŠè¯å¸ˆè€ƒè¯•å‘½é¢˜ä¸“å®¶ã€‚
            
            **ã€æ ¸å¿ƒä»»åŠ¡ã€‘**ï¼š
            ç”¨æˆ·å¯¼å…¥çš„æ‰€æœ‰æ–‡ä»¶å†…å®¹æ„æˆäº†æœ¬æ¬¡è€ƒè¯•çš„**ã€ä¸“å±çŸ¥è¯†åº“ã€‘**ã€‚ä½ éœ€è¦ç»¼åˆé˜…è¯»å¹¶ç†è§£çŸ¥è¯†åº“ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä»½ä¸¥æ ¼ç¬¦åˆã€Š20180628å‡ºé¢˜æ ¼å¼ã€‹çš„è¯•å·ã€‚
            
            **ã€æœ¬æ¬¡è€ƒè¯•æŒ‡å®šè€ƒç‚¹èŒƒå›´ã€‘**ï¼š
            è¯·**ä»…ä»**ä»¥ä¸‹ç”¨æˆ·å‹¾é€‰çš„çŸ¥è¯†ç‚¹èŒƒå›´å†…è¿›è¡Œå‡ºé¢˜ï¼Œå¹¶ç¡®ä¿è¯•é¢˜è¦†ç›–äº†è¿™äº›ç»´åº¦çš„é‡ç‚¹å†…å®¹ï¼š
            ${selectedKPs.join('\n')}

            **ã€å†…å®¹æ¥æºé“å¾‹ã€‘**ï¼š
            1. **ä¸¥æ ¼æº¯æº**ï¼šæ‰€æœ‰çš„è€ƒç‚¹ã€ç—…ä¾‹æ•°æ®ã€è¯ç‰©é€‰æ‹©ä¾æ®ã€æ²»ç–—åŸåˆ™ï¼Œ**å¿…é¡»ä¸¥æ ¼æ¥æºäºç”¨æˆ·æä¾›çš„ã€çŸ¥è¯†åº“å†…å®¹ã€‘**ã€‚
            2. **ç»¼åˆå‡ºé¢˜**ï¼šå¦‚æœç”¨æˆ·ä¸Šä¼ äº†å¤šä»½æ–‡ä»¶ï¼Œè¯·å°è¯•åœ¨è¯•å·ä¸­ç»¼åˆæ¶µç›–è¿™äº›æ–‡ä»¶ä¸­çš„é‡ç‚¹å†…å®¹ã€‚
            3. **ç¦æ­¢å¹»è§‰**ï¼šä¸è¦ç¼–é€ çŸ¥è¯†åº“ä¸­ä¸å­˜åœ¨çš„â€œäº‹å®â€ã€‚

            **ã€å†…å®¹æ·±åº¦è¦æ±‚ã€‘**ï¼š
            1. **è¯å­¦ç›‘æŠ¤æ ¸å¿ƒ**ï¼šé‡ç‚¹è€ƒæ ¸è¯ç‰©é€‰æ‹©ã€ç”¨æ³•ç”¨é‡(å«æº¶åª’/æ»´é€Ÿ)ã€å‰‚å‹é€‚å®œæ€§ã€æ–¹æ¡ˆä¼˜åŒ–ã€å¾ªè¯åŒ»å­¦ã€ADRå¤„ç†ã€æ‚£è€…æ•™è‚²ã€‚
            2. **å¤æ‚ç—…ä¾‹**ï¼šä¸¥é‡çš„è¯ç‰©ç›¸äº’ä½œç”¨ã€ç‰¹æ®Šäººç¾¤ï¼ˆè‚è‚¾åŠŸèƒ½ä¸å…¨ã€è€å¹´ã€å„¿ç«¥ã€å¦Šå¨ ï¼‰ã€é«˜å±è¯å“ï¼ˆæŠ—å‡ã€åŒ–ç–—ã€ç²¾éº»ï¼‰ã€ç‰¹æ®Šå‰‚å‹ï¼ˆç¼“æ§é‡Šã€å¸å…¥å‰‚ï¼‰çš„ä¸´åºŠåº”ç”¨ã€‚
        
            **ã€æ ¼å¼å¼ºåˆ¶è§„èŒƒã€‘**ï¼š
            1. **è€ƒç‚¹æ ‡æ³¨**ï¼šæ¯é“é¢˜ï¼ˆå«æ¡ˆä¾‹å°é¢˜ï¼‰æœ«å°¾å¿…é¡»æ ‡æ³¨è€ƒç‚¹ï¼Œå¿…é¡»å®Œå…¨åŒ¹é…ä¸Šè¿°åˆ—è¡¨ä¸­çš„æ–‡æœ¬ã€‚æ ¼å¼ï¼š...é¢˜å¹²...ï¼ˆ  ï¼‰*ã€ï¼ˆ15ï¼‰é€‰å®šäº”ç§ç–¾ç—…ç–¾ç—…æ²»ç–—ã€‘*
            2. **é¢˜ç›®åºå·ä¸æ ¼å¼**ï¼š
               - **å¿…é¡»**ç»™æ¯ä¸€ä¸ªé¢˜ç›®åŠ ä¸Šåºå·ã€‚ä¾‹å¦‚ï¼š**1.**ã€**2.**ã€‚
               - æ¡ˆä¾‹åˆ†æé¢˜çš„å°é¢˜ä¹Ÿè¦ç¼–å·ï¼Œä¾‹å¦‚ï¼š**1.**ã€**2.**ã€‚        
           3. **é¢˜å‹ç»“æ„**ï¼š
               - Aå‹é¢˜ (å•é€‰, 5é€‰é¡¹, å™è¿°å¼æ¡ˆä¾‹, å¦å®šè¯**åŠ ç²—**)ã€‚
               - Bå‹é¢˜ (é…ä¼, 5é€‰é¡¹åœ¨å‰, å¼•å¯¼å¥æ”¾åœ¨å¤‡é€‰ç­”æ¡ˆä¸é¢˜å¹²ä¹‹é—´çš„ç”¨ä»¥è¯´æ˜ä¸¤è€…çš„å…³ç³»,é¢˜å¹²åœ¨å)ã€‚
               - Xå‹é¢˜ (å¤šé€‰, 5é€‰é¡¹,å™è¿°å¼æ¡ˆä¾‹, å¦å®šè¯**åŠ ç²—**)ã€‚
               - æ¡ˆä¾‹é¢˜ (æ¯æ¡ˆä¾‹>=5å°é¢˜, æ¯é¢˜4é€‰é¡¹)ã€‚
           3. **é¢˜å‹è®¾è®¡è§„èŒƒ**ï¼š
               - **Aå‹é¢˜ (æœ€ä½³é€‰æ‹©é¢˜)**ï¼š
                 - **é¢˜å¹²è¦æ±‚**ï¼šå¿…é¡»é‡‡ç”¨**ä¸´åºŠæ¡ˆä¾‹æ‘˜è¦**ï¼Œä»¥**å™è¿°å¼**ä¹¦å†™ï¼ˆç¦æ­¢ç®€å•çš„çŸ¥è¯†ç‚¹é—®ç­”ï¼‰ã€‚
                 - **è¡¨è¿°è¦æ±‚**ï¼šå°½å¯èƒ½é‡‡ç”¨**è‚¯å®šæ€§é™ˆè¿°å¥**ã€‚
                 - **å¦å®šè¯å¤„ç†**ï¼šå¦‚æœå¿…é¡»é‡‡ç”¨å¦å®šæ€§é™ˆè¿°ï¼ˆå¦‚â€œä¸åŒ…æ‹¬â€ã€â€œä¸å®œâ€ï¼‰ï¼Œå…¶å¦å®šè¯å¿…é¡»ç”¨ **MarkdownåŠ ç²—**ï¼ˆå¦‚ **ä¸**ï¼‰ä»¥æé†’åº”è¯•è€…ã€‚
                 - **é€‰é¡¹è¦æ±‚**ï¼šæ¯é¢˜5ä¸ªé€‰é¡¹ï¼Œå•é€‰ã€‚
               - **Xå‹é¢˜**ï¼š
                 - **é¢˜å¹²è¦æ±‚**ï¼šå¿…é¡»é‡‡ç”¨**ä¸´åºŠæ¡ˆä¾‹æ‘˜è¦**ï¼Œä»¥**å™è¿°å¼**ä¹¦å†™ï¼ˆç¦æ­¢ç®€å•çš„çŸ¥è¯†ç‚¹é—®ç­”ï¼‰ã€‚
                 - **è¡¨è¿°è¦æ±‚**ï¼šå°½å¯èƒ½é‡‡ç”¨**è‚¯å®šæ€§é™ˆè¿°å¥**ã€‚
                 - **å¦å®šè¯å¤„ç†**ï¼šå¦‚æœå¿…é¡»é‡‡ç”¨å¦å®šæ€§é™ˆè¿°ï¼ˆå¦‚â€œä¸åŒ…æ‹¬â€ã€â€œä¸å®œâ€ï¼‰ï¼Œå…¶å¦å®šè¯å¿…é¡»ç”¨ **MarkdownåŠ ç²—**ï¼ˆå¦‚ **ä¸**ï¼‰ä»¥æé†’åº”è¯•è€…ã€‚
                 - **é€‰é¡¹è¦æ±‚**ï¼šæ¯é¢˜5ä¸ªé€‰é¡¹ï¼Œå¤šé€‰ã€‚
               - **Bå‹é¢˜**ï¼šå…ˆåˆ—**5ä¸ªé€‰é¡¹**(A~E)ï¼Œç„¶ååˆ—å‡º2-3ä¸ªé¢˜å¹²ã€‚
                 - **é¢˜å¹²è¦æ±‚**ï¼šå¿…é¡»é‡‡ç”¨**ä¸´åºŠæ¡ˆä¾‹æ‘˜è¦**ï¼Œä»¥**å™è¿°å¼**ä¹¦å†™ï¼ˆç¦æ­¢ç®€å•çš„çŸ¥è¯†ç‚¹é—®ç­”ï¼‰ã€‚
                 - **è¡¨è¿°è¦æ±‚**ï¼šå°½å¯èƒ½é‡‡ç”¨**è‚¯å®šæ€§é™ˆè¿°å¥**ã€‚
                 - **å¦å®šè¯å¤„ç†**ï¼šå¦‚æœå¿…é¡»é‡‡ç”¨å¦å®šæ€§é™ˆè¿°ï¼ˆå¦‚â€œä¸åŒ…æ‹¬â€ã€â€œä¸å®œâ€ï¼‰ï¼Œå…¶å¦å®šè¯å¿…é¡»ç”¨ **MarkdownåŠ ç²—**ï¼ˆå¦‚ **ä¸**ï¼‰ä»¥æé†’åº”è¯•è€…ã€‚
                 - **é€‰é¡¹è¦æ±‚**ï¼šæ¯é¢˜5ä¸ªé€‰é¡¹ï¼Œå•é€‰ã€‚
               - **æ¡ˆä¾‹åˆ†æé¢˜**ï¼š
                 - **é¢˜å¹²è¦æ±‚**ï¼šå¿…é¡»é‡‡ç”¨**ä¸´åºŠæ¡ˆä¾‹æ‘˜è¦**ï¼Œä»¥**å™è¿°å¼**ä¹¦å†™ï¼ˆç¦æ­¢ç®€å•çš„çŸ¥è¯†ç‚¹é—®ç­”ï¼‰ã€‚
                 - **è¡¨è¿°è¦æ±‚**ï¼šå°½å¯èƒ½é‡‡ç”¨**è‚¯å®šæ€§é™ˆè¿°å¥**ã€‚
                 - **å¦å®šè¯å¤„ç†**ï¼šå¦‚æœå¿…é¡»é‡‡ç”¨å¦å®šæ€§é™ˆè¿°ï¼ˆå¦‚â€œä¸åŒ…æ‹¬â€ã€â€œä¸å®œâ€ï¼‰ï¼Œå…¶å¦å®šè¯å¿…é¡»ç”¨ **MarkdownåŠ ç²—**ï¼ˆå¦‚ **ä¸**ï¼‰ä»¥æé†’åº”è¯•è€…ã€‚
                 - **é€‰é¡¹è¦æ±‚**ï¼šæ¯ä¸ªæ¡ˆä¾‹è®¾è®¡**ä¸å°‘äº5ä¸ªé—®é¢˜**ã€‚æ¯ä¸ªé—®é¢˜è®¾è®¡**4ä¸ªé€‰é¡¹**ï¼Œå¯å•é€‰æˆ–å¤šé€‰ã€‚
            4. **æ’ç‰ˆ**ï¼š
               - # ${config.Title}
               - **å§“åï¼š______ ç§‘å®¤ï¼š______ åˆ†æ•°ï¼š______**
               - ## ä¸€ã€Aå‹é¢˜ï¼ˆ...å…±${config.A}é¢˜ï¼‰
               - ## äºŒã€Bå‹é¢˜ï¼ˆ...å…±${config.B}ç»„ï¼‰
               - ## ä¸‰ã€Xå‹é¢˜ï¼ˆ...å…±${config.X}é¢˜ï¼‰
               - ## å››ã€æ¡ˆä¾‹åˆ†æé¢˜ï¼ˆ...å…±${config.Case}ä¸ªæ¡ˆä¾‹ï¼‰
               - (æ¯é¢˜åé¢) # å‚è€ƒç­”æ¡ˆ
            4. **æ’ç‰ˆ**ï¼š
           - # ${config.Title}  
           - **å§“åï¼š______ ç§‘å®¤ï¼š______ åˆ†æ•°ï¼š______**
           - ---
           - ## ä¸€ã€Aå‹é¢˜ï¼ˆ...å…±${config.A}é¢˜ï¼‰
           - [æŒ‰é¡ºåºç”Ÿæˆé¢˜ç›®]
               - > **å‚è€ƒç­”æ¡ˆ**ï¼š[ç­”æ¡ˆ]
               - > **è§£æ**ï¼š[å…³é”®çŸ¥è¯†ç‚¹è§£æ]
           - ## äºŒã€Bå‹é¢˜ï¼ˆ...å…±${config.B}ç»„ï¼‰
           - [æŒ‰é¡ºåºç”Ÿæˆé¢˜ç›®]
              - > **å‚è€ƒç­”æ¡ˆ**ï¼š[ç­”æ¡ˆ]
          - ## ä¸‰ã€Xå‹é¢˜ï¼ˆ...å…±${config.X}é¢˜ï¼‰
         - [æŒ‰é¡ºåºç”Ÿæˆé¢˜ç›®]
              - > **å‚è€ƒç­”æ¡ˆ**ï¼š[ç­”æ¡ˆ]
          - ## å››ã€æ¡ˆä¾‹åˆ†æé¢˜ï¼ˆ...å…±${config.Case}ä¸ªæ¡ˆä¾‹ï¼‰
          - [æ¡ˆä¾‹æè¿°]
          - [é—®é¢˜]
              - > **å‚è€ƒç­”æ¡ˆ**ï¼š[ç­”æ¡ˆ]
            **ç”Ÿæˆæ•°é‡**ï¼šAå‹${config.A}é¢˜, Bå‹${config.B}ç»„, Xå‹${config.X}é¢˜, æ¡ˆä¾‹${config.Case}ä¸ªã€‚
            `;


            try {
                let md = "";
                if(provider === 'gemini') {
                    md = await callGemini(key, document.getElementById('geminiModelId').value, sys, context);
                } else {
                    const url = provider==='openai' ? 'https://api.openai.com/v1' : document.getElementById('customBaseUrl').value;
                    const model = provider==='openai' ? 'gpt-4-turbo' : document.getElementById('customModelId').value;
                    md = await callOpenAI(key, url, model, sys, context);
                }
                
                marked.setOptions({ gfm: true, breaks: true });
                const html = marked.parse(md);
                outputDiv.innerHTML = html;
                
                // Style fix
                document.querySelectorAll('em').forEach(e => { if(e.innerText.includes('ã€')) e.className='knowledge-point'; });

            } catch(e) {
                console.error(e);
                outputDiv.innerHTML = `<div class="p-4 text-red-500 bg-red-50 rounded border border-red-200">
                    <h3 class="font-bold">ç”Ÿæˆå‡ºé”™</h3>
                    <p>${e.message}</p>
                    <p class="text-sm mt-2 text-gray-500">
                        <ul class="list-disc pl-5">
                            <li>æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®</li>
                            <li>æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆæ˜¯å¦èƒ½è®¿é—® API åŸŸåï¼‰</li>
                            <li>å¦‚æœä½¿ç”¨ DeepSeek/SiliconFlowï¼Œç¡®ä¿æ¨¡å‹ ID æ­£ç¡®</li>
                            <li>å°è¯•å‡å°‘é¢˜ç›®æ•°é‡</li>
                        </ul>
                    </p>
                </div>`;
            }
            btn.disabled = false;
            btn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> å¼€å§‹ç”Ÿæˆè¯•å·`;
        }

        // --- API Calls ---
        async function callGemini(key, model, sys, user) {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ contents:[{ role:"user", parts:[{text: sys+"\n\nç›¸å…³èµ„æ–™:\n"+user}] }] })
            });
            const d = await res.json();
            if(!res.ok) throw new Error(d.error?.message||"Gemini API Error");
            return d.candidates?.[0]?.content?.parts?.[0]?.text || "æœªç”Ÿæˆå†…å®¹";
        }
        async function callOpenAI(key, url, model, sys, user) {
            const res = await fetch(`${url.replace(/\/$/,'')}/chat/completions`, {
                method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`},
                body:JSON.stringify({ model:model, messages:[{role:"system",content:sys},{role:"user",content:user}] })
            });
            const d = await res.json();
            if(!res.ok) throw new Error(d.error?.message||"API Error");
            return d.choices[0].message.content;
        }
        
        function printExam() { window.print(); }
        function exportToWord() {
            const blob = new Blob([document.getElementById('markdownOutput').innerText], {type:'text/plain'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='exam.md'; a.click();
        }
    </script>
</body>
</html>
